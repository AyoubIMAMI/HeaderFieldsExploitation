using System;
using System.Collections.Generic;
using System.Net;
using System.Web.Http;
using System.Text.Json;
using System.Text.Json.Serialization;
using static System.Net.WebRequestMethods;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Security.Policy;

namespace OwinSelfhostSample
{
    public class ServerController : ApiController
    {
        // GET api/server 
        public string Get()
        {
            List<string> serverUrls = new List<string>() {
            "http://www.tigli.fr/",
            "https://www.youtube.com/",
            "https://www.twitch.tv/",
            "https://www.wikipedia.fr/",
            "http://puissancecraft.connect4.academy/",
            "https://fr.wikipedia.org/wiki/R%C3%A9seau_informatique",
            "https://www.lemonde.fr/",
            "https://twitter.com/",
            "https://www.amazon.com/",
            "https://www.airbnb.com/",
            "https://www.revolut.com/"
            };

            Dictionary<string, int> serverStats = new Dictionary<string, int>();

            foreach (string url in serverUrls)
            {
                try
                {
                    HttpResponseMessage response;
                    HttpClient client = new HttpClient();
                    client.BaseAddress = new Uri(url);
                    response = client.GetAsync("").Result;
                    response.EnsureSuccessStatusCode();
                    HttpResponseHeaders header = response.Headers;

                    string serverType = header.Server.ToString();
                    if (!String.IsNullOrEmpty(serverType))
                    {
                        if (serverStats.ContainsKey(serverType))
                        {
                            serverStats[serverType]++;
                        }
                        else
                        {
                            serverStats.Add(serverType, 1);
                        }
                    }
                }
                catch (HttpRequestException e)
                {
                    Console.WriteLine("\nException Caught!");
                    Console.WriteLine("Message :{0} ", e.Message);
                }
            }

            Console.WriteLine("Server statistics:");
            foreach (KeyValuePair<string, int> stat in serverStats)
            {
                Console.WriteLine($"{stat.Key}: {stat.Value}");
            }

            return JsonSerializer.Serialize(serverStats);
        }
    }
}