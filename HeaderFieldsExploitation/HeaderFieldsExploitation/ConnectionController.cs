using System;
using System.Collections.Generic;
using System.Net;
using System.Web.Http;
using System.Text.Json;
using System.Text.Json.Serialization;
using static System.Net.WebRequestMethods;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Security.Policy;
using System.Runtime.Remoting.Messaging;

namespace OwinSelfhostSample
{
    public class ConnectionController : ApiController
    {
        public string Get()
        {
            List<string> urls = new List<string>() {
                "http://www.tigli.fr/",
                "https://www.youtube.com/",
                "https://www.twitch.tv/",
                "https://www.wikipedia.fr/",
                "http://puissancecraft.connect4.academy/"
            };

            Dictionary<string, string> data = new Dictionary<string, string>();

            foreach (string url in urls)
            {
                try
                {
                    Console.WriteLine("try");
                    HttpResponseMessage response;
                    HttpClient client = new HttpClient();
                    client.BaseAddress = new Uri(url);
                    response = client.GetAsync("").Result;
                    response.EnsureSuccessStatusCode();
                    HttpResponseHeaders header = response.Headers;

                    data.Add(url, header.Connection.ToString());
                    Console.WriteLine(header);

                }
                catch (HttpRequestException e)
                {
                    Console.WriteLine("\nException Caught!");
                    Console.WriteLine("Message :{0} ", e.Message);
                }
            }
            return JsonSerializer.Serialize(data);
        }
    }
}